generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String      @id @default(uuid())
  email         String      @unique
  username      String      @unique
  password      String
  firstName     String?
  lastName      String?
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  userRoles     UserRole[]
  auditLogs     AuditLog[]
  assignedRoles UserRole[]  @relation("AssignedBy")
  
  // Related entities
  hosts         Host[]
  subAgents     SubAgent[]
  approved      Approved[]
  trustedPersons TrustedPerson[]
  supervisors   Supervisor[]
  marketers     Marketer[]
  
  @@map("users")
}

model Role {
  id          String       @id @default(uuid())
  name        String       @unique
  description String?
  isActive    Boolean      @default(true)
  isSystem    Boolean      @default(false)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  permissions RolePermission[]
  userRoles   UserRole[]
  
  @@map("roles")
}

model Permission {
  id          String       @id @default(uuid())
  name        String       @unique
  resource    String
  action      Action
  description String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  roles       RolePermission[]
  
  @@unique([resource, action])
  @@map("permissions")
}

model RolePermission {
  id           String     @id @default(uuid())
  roleId       String
  permissionId String
  createdAt    DateTime   @default(now())
  
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  
  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model UserRole {
  id         String   @id @default(uuid())
  userId     String
  roleId     String
  assignedAt DateTime @default(now())
  assignedBy String?
  
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role       Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  assignedByUser User? @relation("AssignedBy", fields: [assignedBy], references: [id], onDelete: SetNull)
  
  @@unique([userId, roleId])
  @@map("user_roles")
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?
  action     String
  resource   String
  resourceId String?
  oldValues  Json?
  newValues  Json?
  timestamp  DateTime @default(now())
  ipAddress  String?
  userAgent  String?
  
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([resource])
  @@index([timestamp])
  @@map("audit_logs")
}

enum Action {
  CREATE
  READ
  UPDATE
  DELETE
}

enum SalaryType {
  MONTHLY
  BIWEEKLY
}

enum SupervisorType {
  AGENCY
  WHATSAPP
}

enum TransferMethod {
  MANUAL_CASH
  BANK_TRANSFER
  CHECK
}

enum TransferStatus {
  PENDING
  COMPLETED
  VERIFIED
}

enum RecordSalaryType {
  SALARY
  ADVANCE
  OTHER
}

enum ShippingStatus {
  PENDING
  IN_TRANSIT
  DELIVERED
  CANCELLED
}

enum CompanyType {
  CLIENT
  SUPPLIER
  BOTH
}

enum CreditStatus {
  OPEN
  CLOSED
  CANCELLED
}

// ============ New User Types ============

model Host {
  id              String    @id @default(uuid())
  userId          String
  fullName        String
  agencyName      String
  address         String
  whatsappNumber  String
  notes           String?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("hosts")
}

model SubAgent {
  id                String    @id @default(uuid())
  userId            String
  roomId            String
  activationCode    String
  numberOfUsers     Int       @default(0)
  whatsappNumber    String
  commissionRate    Decimal   @db.Decimal(5, 2)
  totalAgencyAmount Decimal   @db.Decimal(15, 2) @default(0)
  agencyName        String
  notes             String?
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("sub_agents")
}

model Approved {
  id              String    @id @default(uuid())
  userId          String
  approvedName    String
  whatsappNumber  String
  amount          Decimal   @db.Decimal(15, 2)
  approvalDate    DateTime?
  numberOfUsers   Int       @default(0)
  countries       Json?     // JSON array of countries
  address         String?
  notes           String?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("approved")
}

model TrustedPerson {
  id              String            @id @default(uuid())
  userId          String?
  fullName        String
  address         String
  whatsappNumber  String
  idDocuments     Json?             // JSON array of file URLs
  salaryType      SalaryType
  baseSalary      Decimal           @db.Decimal(10, 2)
  salaryPeriod    String?
  bankAccount     String?
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  user            User?             @relation(fields: [userId], references: [id], onDelete: SetNull)
  manualTransfers ManualTransfer[]
  
  @@map("trusted_persons")
}

model Supervisor {
  id              String        @id @default(uuid())
  userId          String
  supervisorType  SupervisorType
  salary          Decimal       @db.Decimal(10, 2)
  salaryPeriod    SalaryType
  fullName        String
  whatsappNumber  String
  isActive        Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("supervisors")
}

model Marketer {
  id                String    @id @default(uuid())
  userId            String
  fullName          String
  numberOfPeople    Int       @default(0)
  marketingMethods  Json?     // JSON array: facebook, instagram, whatsapp, other
  marketingSalary   Decimal   @db.Decimal(10, 2) @default(0)
  profitPerCustomer Decimal   @db.Decimal(10, 2) @default(0)
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("marketers")
}

// ============ Existing Models ============

model Company {
  id            String    @id @default(uuid())
  name          String    @unique
  type          CompanyType
  contactPerson String?
  phone         String?
  email         String?
  address       String?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  sentShipments     Shipping[] @relation("SentShipments")
  receivedShipments Shipping[] @relation("ReceivedShipments")
  
  @@map("companies")
}

model Shipping {
  id              String         @id @default(uuid())
  trackingNumber  String         @unique
  senderId        String
  receiverId      String
  origin          String
  destination     String
  weight          Decimal        @db.Decimal(10, 2)
  cost            Decimal        @db.Decimal(10, 2)
  price           Decimal        @db.Decimal(10, 2)
  status          ShippingStatus @default(PENDING)
  shipmentDate    DateTime       @default(now())
  estimatedArrival DateTime?
  notes           String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  sender          Company        @relation("SentShipments", fields: [senderId], references: [id])
  receiver        Company        @relation("ReceivedShipments", fields: [receiverId], references: [id])
  
  @@map("shipping")
}

model Credit {
  id            String       @id @default(uuid())
  creditNumber  String       @unique
  bankName      String
  amount        Decimal      @db.Decimal(15, 2)
  currency      String       @default("USD")
  openDate      DateTime     @default(now())
  expiryDate    DateTime
  status        CreditStatus @default(OPEN)
  notes         String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  
  @@map("credits")
}

model ExchangeRate {
  id            String   @id @default(uuid())
  fromCurrency  String
  toCurrency    String
  rate          Decimal  @db.Decimal(10, 4)
  date          DateTime @default(now())
  createdAt     DateTime @default(now())
  
  @@map("exchange_rates")
}

model ManualTransfer {
  id              String           @id @default(uuid())
  trustedPersonId String
  period          String
  amount          Decimal          @db.Decimal(10, 2)
  currency        String           @default("IQD")
  transferDate    DateTime
  transferMethod  TransferMethod
  recipientInfo   String?
  status          TransferStatus   @default(PENDING)
  notes           String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  trustedPerson   TrustedPerson    @relation(fields: [trustedPersonId], references: [id], onDelete: Cascade)
  transferRecords TransferRecord[]
  
  @@map("manual_transfers")
}

model TransferRecord {
  id               String            @id @default(uuid())
  manualTransferId String
  userId           String?
  employeeName     String
  amount           Decimal           @db.Decimal(10, 2)
  salaryType       RecordSalaryType
  description      String?
  confirmed        Boolean           @default(false)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  
  manualTransfer   ManualTransfer    @relation(fields: [manualTransferId], references: [id], onDelete: Cascade)
  
  @@map("transfer_records")
}
